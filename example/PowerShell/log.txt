
D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & where pwsh
続行するには何かキーを押してください . . .
D:\TOOL\PowerShell-7.0.6-win-x64\pwsh.exe

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & dir
続行するには何かキーを押してください . . .
 ドライブ D のボリューム ラベルがありません。
 ボリューム シリアル番号は 5E5B-9C13 です

 D:\TOOL\C1Tester-main\C1Tester\C1TesterCore のディレクトリ

2021/07/06  19:31    <DIR>          .
2021/07/06  19:31    <DIR>          ..
2021/07/06  19:28             1,901 C1TesterCore.pssproj
2021/07/06  19:46            17,026 c1tester_add_trace.ps1
2021/07/06  19:31    <DIR>          ObjectCode
               2 個のファイル              18,927 バイト
               3 個のディレクトリ  152,122,855,424 バイトの空き領域

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & dir ..\..\example\PowerShell
続行するには何かキーを押してください . . .
 ドライブ D のボリューム ラベルがありません。
 ボリューム シリアル番号は 5E5B-9C13 です

 D:\TOOL\C1Tester-main\example\PowerShell のディレクトリ

2021/07/06  19:48    <DIR>          .
2021/07/06  19:48    <DIR>          ..
2021/07/06  19:28               737 example.ps1
               1 個のファイル                 737 バイト
               2 個のディレクトリ  152,122,265,600 バイトの空き領域

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\example.ps1
続行するには何かキーを押してください . . .
function f1($number)
{
    for ($i = 0; $i -le $number; $i++)
    {
        if ($i % 2 -eq 0)
        {
            Write-Host ([string]$i + " is even.")
        }
        else
        {
            Write-Host ([string]$i + " is odd.")
        }

        switch ($i)
        {
            1
            {
                Write-Host ([string]$i + " is one.")
                break
            }
            2
            {
                Write-Host ([string]$i + " is two.")
                break
            }
            Default
            {
                break
            }
        }
    }
}

if (([int]$args[0] -lt 0) -or ([int]$args[0] -gt 5))
{
    Write-Host ("argument must be 0-5.")
    exit(1)
}

f1([int]$args[0])

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & pwsh ..\..\example\PowerShell\example.ps1 5
続行するには何かキーを押してください . . .
0 is even.
1 is odd.
1 is one.
2 is even.
2 is two.
3 is odd.
4 is even.
5 is odd.

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & pwsh ..\..\example\PowerShell\example.ps1 6
続行するには何かキーを押してください . . .
argument must be 0-5.

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & pwsh c1tester_add_trace.ps1 -report ..\..\example\PowerShell\example.ps1
続行するには何かキーを押してください . . .
トレース追加を完了しました。

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & dir ..\..\example\PowerShell
続行するには何かキーを押してください . . .
 ドライブ D のボリューム ラベルがありません。
 ボリューム シリアル番号は 5E5B-9C13 です

 D:\TOOL\C1Tester-main\example\PowerShell のディレクトリ

2021/07/06  19:52    <DIR>          .
2021/07/06  19:52    <DIR>          ..
2021/07/06  19:52               137 c1tester_example.ps1_report.csv
2021/07/06  19:52             4,377 example.ps1
2021/07/06  19:28               737 _example.ps1
               3 個のファイル               5,251 バイト
               2 個のディレクトリ  152,120,029,184 バイトの空き領域

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\example.ps1
続行するには何かキーを押してください . . .
・ｿ# c1tester no trace start
#   繝悶Ο繝・け繧ｳ繝｡繝ｳ繝医・繧ｹ繧ｯ繝ｪ繝励ヨ縺ｫ繧医▲縺ｦ鄂ｮ謠帙＆繧後ｋ縲・
class c1tester
{
    hidden [bool] $h_enabled_trace = $true
    hidden [string] $h_pass_file
    hidden [string] $h_report_file
    hidden [bool] $h_enabled_report
    hidden $h_pass
    hidden $h_csv
    hidden $h_report_hash

    c1tester()
    {
        # 繝医Ξ繝ｼ繧ｹ縺檎┌蜉ｹ縺・
        if (-not $this.h_enabled_trace)
        {
            return
        }

        $this.h_pass = @{}
        $this.h_report_hash = @{}
        $stack = Get-PSCallStack
        $selffilename = Split-Path $stack[1].ScriptName -Leaf
        $self_folder = Split-Path $stack[1].ScriptName -Parent
        $this.h_pass_file = $self_folder + '\\{0}_{1}_pass.csv' -f 'c1tester', $selffilename

        #縲騾夐℃繝輔ぃ繧､繝ｫ縺梧怏繧九°
        if (Test-Path $this.h_pass_file)
        {
            Remove-Item $this.h_pass_file
        }

        $report_file_backup = $self_folder + '\\_{0}_{1}_report.csv' -f 'c1tester', $selffilename
        $this.h_report_file = $self_folder + '\\{0}_{1}_report.csv' -f 'c1tester', $selffilename
        $this.h_enabled_report = $false

        # 蝣ｱ蜻翫ヵ繧｡繧､繝ｫ縺梧怏繧九°
        if (Test-Path $this.h_report_file)
        {
            $this.h_csv = Import-Csv $this.h_report_file -Encoding utf8

            # 蜃ｦ逅・婿豕輔ｒ蜷台ｸ翫☆繧九◆繧√・繝上ャ繧ｷ繝･繝・・繝悶Ν繧剃ｽ懈・縺吶ｋ繝ｫ繝ｼ繝・
            for ($i = 0; $i -lt $this.h_csv.Count; $i++)
            {
                $this.h_report_hash[$this.h_csv[$i].trace_id] = $i
            }

            # 蝣ｱ蜻翫ヵ繧｡繧､繝ｫ縺ｮ繝舌ャ繧ｯ繧｢繝・・縺梧怏繧九°
            if (Test-Path $report_file_backup)
            {
                Remove-Item $report_file_backup
            }

            Rename-Item $this.h_report_file $report_file_backup
            $this.h_enabled_report = $true
        }
    }

    [void] trace($trace_id)
    {
        # 繝医Ξ繝ｼ繧ｹ縺檎┌蜉ｹ縺・
        if (-not $this.h_enabled_trace)
        {
            return
        }

        # 譛ｪ蜃ｺ蜉帙°
        if ($this.h_pass.Keys -notcontains $trace_id)
        {
            $tmp = Get-PSCallStack
            $filename = Split-Path $tmp[1].ScriptName -Leaf
            $content = $filename + ":" + $tmp[1].ScriptLineNumber + "(" + $tmp[1].FunctionName + ") " + (Get-Date -Format 'yyyy/MM/dd HH:mm:ss')
            $trace_id + "," + $content | Out-File ($this.h_pass_file) -Append -Encoding utf8
            $this.h_pass[$trace_id] = $true

            # 蝣ｱ蜻翫☆繧九°
            if ($this.h_enabled_report)
            {
                # 繧ｨ繝ｳ繝医Μ繝ｼ縺梧怏繧九°
                if ($this.h_report_hash.Keys -contains $trace_id)
                {
                    $index = $this.h_report_hash[$trace_id]

                    # 譛ｪ繝代せ縺・
                    if ($this.h_csv[$index].report -eq '-')
                    {
                        $this.h_csv[$index].report = 'P'
                        $this.h_csv[$index].timestamp = $content
                        $this.h_csv | Select-Object -Property trace_id,report,timestamp | Export-Csv -Path $this.h_report_file -Encoding utf8 -NoTypeInformation
                    }
                }
            }
        }
    }
}
# c1tester no trace end

[c1tester]$c1tester = [c1tester]::new()
function f1($number)
{
$c1tester.trace("1")
    for ($i = 0; $i -le $number; $i++)
    {
$c1tester.trace("2")
        if ($i % 2 -eq 0)
        {
$c1tester.trace("3")
            Write-Host ([string]$i + " is even.")
        }
        else
        {
$c1tester.trace("4")
            Write-Host ([string]$i + " is odd.")
        }

        switch ($i)
        {
            1
            {
$c1tester.trace("5")
                Write-Host ([string]$i + " is one.")
                break
            }
            2
            {
$c1tester.trace("6")
                Write-Host ([string]$i + " is two.")
                break
            }
            Default
            {
$c1tester.trace("7")
                break
            }
        }
    }
}

if (([int]$args[0] -lt 0) -or ([int]$args[0] -gt 5))
{
$c1tester.trace("8")
    Write-Host ("argument must be 0-5.")
    exit(1)
}

f1([int]$args[0])

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\c1tester_example.ps1_report.csv
続行するには何かキーを押してください . . .
"trace_id","report","timestamp"
"1","-","-"
"2","-","-"
"3","-","-"
"4","-","-"
"5","-","-"
"6","-","-"
"7","-","-"
"8","-","-"

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & pwsh ..\..\example\PowerShell\example.ps1 5
続行するには何かキーを押してください . . .
0 is even.
1 is odd.
1 is one.
2 is even.
2 is two.
3 is odd.
4 is even.
5 is odd.

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & dir ..\..\example\PowerShell
続行するには何かキーを押してください . . .
 ドライブ D のボリューム ラベルがありません。
 ボリューム シリアル番号は 5E5B-9C13 です

 D:\TOOL\C1Tester-main\example\PowerShell のディレクトリ

2021/07/06  19:52    <DIR>          .
2021/07/06  19:52    <DIR>          ..
2021/07/06  19:52               301 c1tester_example.ps1_pass.csv
2021/07/06  19:52               403 c1tester_example.ps1_report.csv
2021/07/06  19:52             4,377 example.ps1
2021/07/06  19:52               137 _c1tester_example.ps1_report.csv
2021/07/06  19:28               737 _example.ps1
               5 個のファイル               5,955 バイト
               2 個のディレクトリ  152,118,063,104 バイトの空き領域

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\c1tester_example.ps1_pass.csv
続行するには何かキーを押してください . . .
1,example.ps1:102(f1) 2021/07/06 19:52:53
2,example.ps1:105(f1) 2021/07/06 19:52:53
3,example.ps1:108(f1) 2021/07/06 19:52:53
7,example.ps1:133(f1) 2021/07/06 19:52:53
4,example.ps1:113(f1) 2021/07/06 19:52:53
5,example.ps1:121(f1) 2021/07/06 19:52:53
6,example.ps1:127(f1) 2021/07/06 19:52:53

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\c1tester_example.ps1_report.csv
続行するには何かキーを押してください . . .
"trace_id","report","timestamp"
"1","P","example.ps1:102(f1) 2021/07/06 19:52:53"
"2","P","example.ps1:105(f1) 2021/07/06 19:52:53"
"3","P","example.ps1:108(f1) 2021/07/06 19:52:53"
"4","P","example.ps1:113(f1) 2021/07/06 19:52:53"
"5","P","example.ps1:121(f1) 2021/07/06 19:52:53"
"6","P","example.ps1:127(f1) 2021/07/06 19:52:53"
"7","P","example.ps1:133(f1) 2021/07/06 19:52:53"
"8","-","-"

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & pwsh ..\..\example\PowerShell\example.ps1 6
続行するには何かキーを押してください . . .
argument must be 0-5.

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & dir ..\..\example\PowerShell
続行するには何かキーを押してください . . .
 ドライブ D のボリューム ラベルがありません。
 ボリューム シリアル番号は 5E5B-9C13 です

 D:\TOOL\C1Tester-main\example\PowerShell のディレクトリ

2021/07/06  19:53    <DIR>          .
2021/07/06  19:53    <DIR>          ..
2021/07/06  19:53                54 c1tester_example.ps1_pass.csv
2021/07/06  19:53               452 c1tester_example.ps1_report.csv
2021/07/06  19:52             4,377 example.ps1
2021/07/06  19:52               403 _c1tester_example.ps1_report.csv
2021/07/06  19:28               737 _example.ps1
               5 個のファイル               6,023 バイト
               2 個のディレクトリ  152,116,162,560 バイトの空き領域

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\c1tester_example.ps1_pass.csv
続行するには何かキーを押してください . . .
8,example.ps1:142(<ScriptBlock>) 2021/07/06 19:53:01

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>pause   & type ..\..\example\PowerShell\c1tester_example.ps1_report.csv
続行するには何かキーを押してください . . .
"trace_id","report","timestamp"
"1","P","example.ps1:102(f1) 2021/07/06 19:52:53"
"2","P","example.ps1:105(f1) 2021/07/06 19:52:53"
"3","P","example.ps1:108(f1) 2021/07/06 19:52:53"
"4","P","example.ps1:113(f1) 2021/07/06 19:52:53"
"5","P","example.ps1:121(f1) 2021/07/06 19:52:53"
"6","P","example.ps1:127(f1) 2021/07/06 19:52:53"
"7","P","example.ps1:133(f1) 2021/07/06 19:52:53"
"8","P","example.ps1:142(<ScriptBlock>) 2021/07/06 19:53:01"

D:\TOOL\C1Tester-main\C1Tester\C1TesterCore>